
```{r plotting function code}
#dependencies
library(ggpubr)

#theme function code----
theme_gaia = function(base_size =12){
  theme_pubr(base_family="sans") %+replace%
    theme(panel.background  = element_blank(),
      plot.background = element_rect(fill="transparent", colour=NA), 
      legend.background = element_rect(fill="transparent", colour=NA),
      legend.key = element_rect(fill="transparent", colour=NA),
      legend.text = element_text(size=base_size * 0.7),
      legend.title = element_text(size = base_size * 0.8, 
                                  face = "bold"),
      axis.text = element_text(size = base_size*0.85),
      axis.title = element_text(size = base_size * 1.2),
      plot.title.position = "panel",
      plot.caption.position = "panel",
      plot.title = element_text(
        size = base_size * 1.25,
        face = "bold", 
        hjust = 0.5,
        vjust = 1),
      plot.subtitle = element_text(
        size = base_size * 0.9,
        vjust = 1),
      plot.caption =  element_text(
        size = base_size*0.75,
        hjust = 0.5)
    )
  
}
```

```{r analysis control panel 1.0}
#dependencies----
require(viridisLite)
#executing main analyses----
source("RScripts/PlantDiversity.R")
source("RScripts/CanopyCover.R")
source("RScripts/AirQuality.R")
source("RScripts/BugDiversity_1.0.R") 
source("RScripts/GIS.R")

#merge data for plotting----
#all diversity scores
Full_DivScore_Data <- BugDiv_Indices %>%
  select(!("Fungivore-Coleoptera":"Predator-Neuroptera")) %>% 
  left_join(., select(Veg_Data_wide,SiteRep,
                      starts_with("Plant"), 
                      starts_with("Tree"),
                      starts_with("Veg")), by ="SiteRep") %>% 
  arrange(SiteRep)

#environmental data
FullEnviron_Data <- Veg_Data_wide %>% 
  select(SiteRep, Date, Sample_Time, PropTrees_Sampled, CanopyCoverPer) %>% 
  left_join(., select(GIS_Data, !geometry), by = "SiteRep") %>% 
  left_join(., AQ_Summary, by = "SiteRep") %>% 
  filter(is.na(AVG_PM2.5) != T) %>% 
  arrange(SiteRep)


#calculate PCAs of variables----
#anthropogenic factor
AnthroLandscape_PCA <-prcomp(filter(select(FullEnviron_Data, 
                                           contains("1km"), 
                                           contains("Annum"), 
                                           contains("PM")), is.na(AVG_PM2.5) != T), scale. = T)
#correl plot 
corrplot::corrplot(AnthroLandscape_PCA$rotation,col = colorRampPalette(viridis(50))(50),#number of breaks in brackets
                   addCoef.col = "black", tl.col = "black")



#

#correl between vars
cor_environLandscape <- cor(filter(select(FullEnviron_Data, 
                                           contains("1km"), 
                                           contains("Annum"), 
                                           contains("PM")), is.na(AVG_PM2.5) != T))
corrplot::corrplot(cor_environLandscape)
#scree plot
factoextra::fviz_eig(AnthroLandscape_PCA)


#fn abundances
Bug_PCA <-prcomp(select(BugDiv_Abundance,"Fungivore-Coleoptera":"Predator-Neuroptera"), scale. = T)
#correl plot
corrplot::corrplot(Bug_PCA$rotation,col = colorRampPalette(viridis(50))(50),#number of breaks in brackets
               tl.col = "black")
#correl between vars
bug_cor <- cor(select(BugDiv_Abundance, starts_with("Predator") | starts_with("Herbivore")))
corrplot::corrplot(bug_cor,col = colorRampPalette(viridis(50))(50),#number of breaks in brackets
               tl.col = "black")
#screeplot
factoextra::fviz_eig(Bug_PCA)

#merge PCAs into diversity table
MergedData <- tibble(FullEnviron_Data,
                     rename(select(as_tibble(AnthroLandscape_PCA$x), PC1, PC2), Landscape_PC1 = PC1, Landscape_PC2 = PC2)) %>% 
  left_join(Full_DivScore_Data, by = "SiteRep") %>% 
  filter(is.na(AVG_PM2.5) != T) %>% 
  mutate(Rep = as.factor(str_extract(SiteRep, "[:digit:]")),
         Type = case_when(str_detect(SiteRep, "^U") == T ~ "Urban",
                          str_detect(SiteRep, "^S") == T ~ "Urban",
                          str_detect(SiteRep, "^R" )== T ~ "Rural"),
         Date = as.ordered(Date))



ggplot(MergedData, aes( x = Landscape_PC1, y = as.POSIXct(Date), fill = Type, shape = Rep)) +
  geom_vline(aes(xintercept = 0),linetype = 2) +
  geom_point(size = 5) +
  scale_fill_manual(values = c('#77fffa',"#ff638a") , guide ='none')+
  scale_shape_manual(values = c(21,22)) +
  theme_gaia(base_size = 25)  +
  labs(title = "Clustering \nby Urbanization factor",x = "PC1 (74%)", shape = "Replicate", y = "Date", fill ="Site")

```
### Stats:
```{r statistics}
#linear modelling time!!!


FnGORichness_Model<- glm(data = MergedData, 
            Total_Richness ~ Type + VegRichness + Rep,
            family = "poisson")
summary(FnGORichness_Model)
step(FnGORichness_Model)

ORichness_Model<- glm(data = MergedData, 
            Order_Richness ~ Type + VegRichness + Rep,
            family = "poisson")
summary(ORichness_Model)
FnGRichness_Model<- glm(data = MergedData, 
            FnG_Richness ~ Type + VegRichness + Rep,
            family = "poisson")
summary(FnGRichness_Model)

Shannon_Model <- glm(data = MergedData,
                     FnGO_Shannon ~ Landscape_PC1+VegShannon + Date)
summary(Shannon_Model)
#weirdo elmer
Shannon_Model <- lme4::lmer(data = MergedData,
                     FnGO_Shannon ~ Landscape_PC1 * VegShannon  + (1|Rep))
summary(Shannon_Model)

Even_Model<- glm(data = MergedData, 
            FnGO_Evenness ~ Landscape_PC1 + VegEvenness + Rep)
summary(Even_Model)
InvSimp_Model<- glm(data = MergedData, 
            FnGO_InvSimp ~ Landscape_PC1 + VegInvSimp +AVG_PM2.5 +AVG_TEMP + AVG_HUMID + Rep)
summary(InvSimp_Model)

#c
Richness_Tree<- partykit::ctree(data = MergedData, 
            Total_Richness ~ AVG1km_ALAN + AVG1km_ISC +AVG1km_CC + VegRichness +AVG_PM2.5 +AVG_TEMP + AVG_HUMID + Rep)
partykit::plot.party(Richness_Tree)
```

```{r plotting}
#overall abundance barplot----
ggplot(MergedData, aes(y = FnGO_Shannon, x = Date, fill = as.character(Date))) +
    geom_smooth(aes(fill = Date), method = "lm", se = F, color ="black", linetype = 2 ) +
  geom_point(shape = 21, size = 3) +
  scale_fill_viridis_d() +
    theme_gaia()

BDA <- BugDiv_Decent %>% 
  group_by(FunctionalGroup, Order) %>% 
  summarise(FNGO_ct = n()) %>% 
  group_by(FunctionalGroup) %>% 
  mutate(propFNGO = FNGO_ct/sum(FNGO_ct),
         total = sum(FNGO_ct))

BDA_Labels <- BDA %>% 
  group_by(FunctionalGroup) %>% 
  summarise(total = unique(total)) %>% 
  mutate(label = paste(FunctionalGroup,"n =", total))

BDAL <- c(Detritivore = "Detritivore n = 44",
          Fungivore = "Fungivore n = 3",
          Herbivore ="Herbivore n = 215",
          Omnivore ="Omnivore n = 552",
          Parasitoid = "Parasitoid n = 38",
          Predator= "Predator n = 381")
#all feeding guilds
ggplot(BDA, aes(x = tidytext::reorder_within(Order, propFNGO, FunctionalGroup) 
                ,y =propFNGO, fill = Order, group = Order)) +
  geom_col() + 
  facet_grid(~FunctionalGroup, scales = "free", space = "free", labeller = labeller(FunctionalGroup = BDAL)) +
  theme_gaia(base_size = 18) +
  tidytext::scale_x_reordered() +
  scale_fill_viridis_d() +
  theme( axis.text.x = element_text(angle = 66, vjust = 0.45)) +
  labs(title = "Relative Abundance of Arthropod Orders Between Feeding Guilds",
       x = "Order", y = "% Abundance") 

#herbs, omnis, and preds
ggplot(filter(BDA, FunctionalGroup == "Omnivore" | FunctionalGroup == "Predator"| FunctionalGroup == "Herbivore"), aes(x = tidytext::reorder_within(Order, propFNGO, FunctionalGroup) 
                ,y =propFNGO, fill = Order, group = Order)) +
  geom_col() + 
  facet_wrap(~FunctionalGroup, scales = "free", nrow = 1, labeller = labeller(FunctionalGroup = BDAL)) +
  theme_gaia(base_size = 18) +
  tidytext::scale_x_reordered() +
  scale_fill_viridis_d() +
  theme( axis.text.x = element_text(angle = 66, vjust = 0.45)) +
  labs(title = "Relative Abundance of Arthropod Orders\n Between Feeding Guilds",
       x = "Order", y = "% Abundance") 

#abundances by siterep
BDB <- BugDiv_Decent %>% 
  group_by(Type, FunctionalGroup, Order) %>% 
  summarise(FNGOT_ct = n()) %>% 
  group_by(FunctionalGroup, Type) %>% 
  mutate(propFNGOT = FNGOT_ct/sum(FNGOT_ct),
         total = sum(FNGOT_ct))

ggplot(BDB, aes(x =Type, y = propFNGOT, fill = Order )) +
  geom_col(position = "stack") +
  theme_gaia(25) +
  facet_grid(~FunctionalGroup, scales = "free", space = "free", labeller = labeller(FunctionalGroup = BDAL)) +
  theme( axis.text.x = element_text(angle = 33, vjust = 0.45)) +
  scale_fill_viridis_d() +  labs(title = "Arthropod Functional Communities\n Across Urbanization", x = "",
        y = "% Abundance")

ggplot(BDB, aes(x =tidytext::reorder_within(Order, propFNGOT, Type), y = propFNGOT, fill = Order )) +
  geom_col(position = "dodge") +
  theme_gaia(16) +
  tidytext::scale_x_reordered() +
  facet_grid(~FunctionalGroup, scales = "free", space = "free", labeller = labeller(FunctionalGroup = BDAL)) +
  theme( axis.text.x = element_text(angle = 66, vjust = 0.45)) +
  scale_fill_viridis_d() +
  labs(title = "Relative abundance of Arthropod orders between feeding guilds and sites",
       x = "Order", y = "% Abundance")

#order richness by subjective----
MergedData1 <- MergedData %>% 
  group_by(Type) %>% 
  mutate(OR_se = sd(Order_Richness)/sqrt(n())) %>% 
  summarise(Order_Richness = mean(Order_Richness),
            OR_se = mean(OR_se))

ggplot(MergedData1, aes(x = Type, y = Order_Richness, fill = Type)) +
  geom_errorbar(aes(y = Order_Richness, 
                    ymin = Order_Richness-2*OR_se, 
                    ymax = Order_Richness+2*OR_se)) +
  geom_point(size = 2.5, shape = 21)+
  theme_gaia() +
  scale_fill_viridis_d(begin = 0.2, end = 0.8)

ggplot(MergedData, aes(x = Landscape_PC1, fill = Type)) +geom_bar()


```

```{r mapping}
ggplot() +
  geom_sf(data = NY_County_Shorelines, fill = "tan") +
  geom_sf(data = CityPark_Shapes, fill = "green") +
  coord_sf(xlim = c(587937,613293), ylim= c(4510475,4528568))
```

